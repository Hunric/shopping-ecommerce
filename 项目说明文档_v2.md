# Shopping-Ecommerce 电商平台项目说明文档 (v2 - 基于源码分析)

**版本：v2.0.0 (此文档基于当前项目源代码分析生成)**
**日期：2025年6月16日**
**作者：Roo (AI Assistant)**

**免责声明：** 此文档基于对项目在特定时间点的源代码和配置文件的分析生成。用户反馈之前的Docker配置和项目文档已过时，因此本文档更侧重于从现有代码推断实际功能和架构。部分配置（如Docker Compose中的订单服务、Nginx的完整代理规则）可能与当前代码所揭示的最佳实践或开发环境配置存在差异，这些差异将在文档中指出。

## 目录

1.  [项目概述](#1-项目概述)
2.  [系统架构](#2-系统架构)
    *   2.1 服务模块概览
    *   2.2 请求链路分析 (开发环境 vs. 生产环境)
3.  [技术选型](#3-技术选型)
    *   3.1 前端技术栈
    *   3.2 后端技术栈
    *   3.3 中间件与数据库
4.  [后端服务模块详述](#4-后端服务模块详述)
    *   4.1 用户购物服务 (`shop-service` - 端口 8083)
        *   4.1.1 用户认证模块 (`UserAuthController`, `UserAuthService`)
        *   4.1.2 用户商品浏览模块 (`UserProductController`, `UserProductService`)
        *   4.1.3 购物车模块 (`CartController`, `CartService`)
    *   4.2 商家服务 (`merchant-service` - 端口 8081)
        *   4.2.1 商家账户管理模块 (`MerchantController`, `MerchantService`)
        *   4.2.2 店铺管理模块 (`StoreController`, `StoreService`)
        *   4.2.3 商品SPU/SKU管理模块 (`SpuInfoController`, `SpuInfoService`, `SkuInfoService`)
        *   4.2.4 分类与属性管理模块 (`CategoryController`, `ProductCategoryService`, `CategoryAttributeService`)
        *   4.2.5 商家订单管理模块 (`MerchantOrderController`, `MerchantOrderService`)
        *   4.2.6 (其他控制器简述，如 `DashboardController`, `StoreExtendedController`)
    *   4.3 订单服务 (`order-service` - 预估端口 8084, 上下文路径 `/order`)
        *   4.3.1 用户订单模块 (`UserOrderController`, `UserOrderService`)
        *   4.3.2 收货地址管理模块 (`ShippingInfoController`, `ShippingInfoService`)
    *   4.4 文件服务 (`file-service` - 端口 8082)
        *   4.4.1 文件上传模块 (`FileUploadController`, `FileUploadService`)
5.  [前端项目说明 (`ecommerce-frontend`)](#5-前端项目说明-ecommerce-frontend)
    *   5.1 项目结构与构建 (Vite)
    *   5.2 路由配置 (`src/router/index.ts`)
    *   5.3 状态管理 (Pinia)
    *   5.4 API请求封装 (`src/utils/request.ts`)
    *   5.5 (核心视图组件概览)
6.  [数据库设计](#6-数据库设计) (基于 `docker/mysql/init/02-business-tables.sql`)
    *   6.1 `user_info` (用户信息表)
    *   6.2 `shipping_info` (收货地址表)
    *   6.3 `merchant_info` (商家基础信息表)
    *   6.4 `store_info` (店铺信息表)
    *   6.5 `settlement_info` (结算信息表)
    *   6.6 `product_category` (商品分类表)
    *   6.7 `category_attribute` (分类属性表)
    *   6.8 `attribute_option` (属性可选值表)
    *   6.9 `spu_info` (商品SPU表)
    *   6.10 `sku_info` (商品SKU表)
    *   6.11 `cart_info` (购物车表)
    *   6.12 `order_info` (订单信息表)
    *   6.13 `logistics_info` (物流信息表)
    *   6.14 `payment_info` (支付信息表)
7.  [API接口文档 (核心接口)](#7-api接口文档-核心接口)
    *   7.1 用户认证API (`shop-service` - 基路径 `/api/user/auth`)
    *   7.2 用户商品API (`shop-service` - 基路径 `/api/user`)
    *   7.3 购物车API (`shop-service` - 基路径 `/api/cart`)
    *   7.4 用户订单API (`order-service` - 基路径 `/order/api/user/orders`)
    *   7.5 收货地址API (`order-service` - 基路径 `/order/api/user/shipping`)
    *   7.6 商家账户API (`merchant-service` - 基路径 `/merchant/api/merchant`)
    *   7.7 店铺管理API (`merchant-service` - 基路径 `/merchant/api/merchant/store`)
    *   7.8 商品SPU/SKU API (`merchant-service` - 基路径 `/merchant/api/merchant/spu`)
    *   7.9 分类与属性API (`merchant-service` - 基路径 `/merchant/api/merchant/category`)
    *   7.10 商家订单API (`merchant-service` - 基路径 `/merchant/api/merchant/orders`)
    *   7.11 文件上传API (`file-service` - 基路径 `/api/upload`)
8.  [Docker容器化部署与运维](#8-docker容器化部署与运维)
    *   8.1 Docker Compose 配置分析 (`docker-compose.yml`)
    *   8.2 各服务Dockerfile分析
        *   8.2.1 `merchant-service` Dockerfile
        *   8.2.2 `file-service` Dockerfile
        *   8.2.3 `shop-service` Dockerfile
        *   8.2.4 `frontend` Dockerfile
    *   8.3 Nginx配置分析与生产环境代理问题
    *   8.4 部署与运维建议
9.  [已知问题与待改进点](#9-已知问题与待改进点)
10. [总结](#10-总结)

---

## 1. 项目概述

Shopping-Ecommerce 是一个采用前后端分离、微服务架构设计的全栈电商平台。项目旨在提供一套完整的电商解决方案，涵盖用户购物、商家管理、商品展示、订单处理、文件存储等核心业务功能。

**核心特点 (基于源码分析)：**

*   **微服务架构**: 后端由多个独立的Spring Boot服务构成，包括用户购物服务、商家服务、订单服务和文件服务，每个服务负责特定的业务领域。
*   **现代前端**: 前端采用 Vue 3 + TypeScript + Vite + Element Plus + Pinia 构建，提供响应式的用户界面和良好的开发体验。
*   **数据持久化**: 主要使用 MySQL 存储业务数据，Redis 用于缓存和验证码等临时数据。
*   **API驱动**: 前后端通过 RESTful API 进行通信。
*   **容器化部署**: 项目提供了 Dockerfile 和 Docker Compose 配置，支持容器化部署。
*   **商家功能丰富**: 商家后台提供了包括店铺管理、商品（SPU/SKU）管理、分类属性管理、订单管理等一系列功能。

---

## 2. 系统架构

### 2.1 服务模块概览

根据对项目代码和配置文件的分析，系统主要包含以下服务模块：

*   **前端应用 (`ecommerce-frontend`)**:
    *   技术栈: Vue 3, TypeScript, Vite, Element Plus, Pinia。
    *   职责: 提供用户界面，包括用户购物流程（首页、商品浏览、购物车、下单、用户中心）和商家管理后台界面。
    *   部署: 在Docker生产环境中，由Nginx提供静态资源服务，并通过Nginx代理API请求到后端服务。
*   **用户购物服务 (`shop-service`)**:
    *   技术栈: Spring Boot, Java, MyBatis/Spring Data JPA (待确认具体ORM)。
    *   Docker镜像构建上下文: `back_end/parent-project/shop`。
    *   Docker Compose中监听端口: `8083`。
    *   职责: 处理用户认证 (注册、登录、密码重置)、用户端商品信息展示 (列表、详情、搜索、分类)、购物车管理。
*   **商家服务 (`merchant-service`)**:
    *   技术栈: Spring Boot, Java。
    *   Docker镜像构建上下文: `back_end/parent-project/merchant`。
    *   Docker Compose中监听端口: `8081`。
    *   职责: 处理商家账户管理 (注册、登录、信息修改)、店铺管理、商品SPU/SKU管理 (包括Excel导入)、商品分类与属性管理、商家端订单管理、仪表盘数据统计、验证码服务 (部分)。
    *   Nginx代理路径: `/api/merchant/` 和 `/api/verification/` (指向此服务的 `/merchant` 上下文路径)。
*   **订单服务 (`order-service`)**:
    *   技术栈: Spring Boot, Java, MyBatis (根据配置文件推断)。
    *   源代码位置: `back_end/parent-project/order`。
    *   **配置**: 监听端口 `8084`，上下文路径 `/order` (根据其 `application.yml` 和前端Vite代理配置)。
    *   职责: 处理用户端订单创建与管理、用户收货地址管理。
    *   **注意**: 此服务在当前分析的 `docker-compose.yml` 中未明确定义，这是一个需要解决的配置问题。
*   **文件服务 (`file-service`)**:
    *   技术栈: Spring Boot, Java。
    *   Docker镜像构建上下文: `back_end/parent-project/file` (但Dockerfile实际位于 `docker/file-service/`)。
    *   Docker Compose中监听端口: `8082`。
    *   职责: 处理文件（主要是图片）的上传和删除。
    *   Nginx代理路径: `/api/upload/` 和 `/uploads/`。
*   **数据库服务 (`mysql`)**:
    *   技术栈: MySQL 8.0。
    *   Docker Compose中监听端口: `3306`。
    *   职责: 持久化存储所有业务数据。
*   **缓存服务 (`redis`)**:
    *   技术栈: Redis。
    *   Docker Compose中监听端口: `6379`。
    *   职责: 主要用于存储验证码、可能的Session信息或业务缓存。

### 2.2 请求链路分析

#### 2.2.1 开发环境 (基于 Vite 代理)

在开发环境下，前端应用 (运行在 `http://localhost:3000`) 的API请求通过Vite的 `server.proxy` 配置转发到本地运行的各个后端服务：

*   `/api/merchant/*` -> `http://localhost:8081` (商家服务)
*   `/api/verification/*` -> `http://localhost:8081` (商家服务)
*   `/api/upload/*`, `/uploads/*` -> `http://localhost:8082` (文件服务)
*   `/api/user/*` (除订单/收货地址外) -> `http://localhost:8083` (用户购物服务)
*   `/api/cart/*` -> `http://localhost:8083` (用户购物服务)
*   `/api/user/shipping/*`, `/api/user/orders/*`, `/api/order/*` -> `http://localhost:8084` (订单服务)

#### 2.2.2 生产环境 (Docker + Nginx - 当前存在问题)

在Docker生产环境中，前端应用由Nginx容器提供服务 (监听主机 `3000` 端口，映射到容器 `80` 端口)。

*   **静态资源**: Nginx直接提供 `ecommerce-frontend` 构建后的静态文件。
*   **API请求**:
    *   **已配置代理**:
        *   `/api/merchant/*` -> `merchant-service:8081` (通过Nginx的 `proxy_pass`)
        *   `/api/verification/*` -> `merchant-service:8081`
        *   `/api/upload/*` -> `file-service:8082`
        *   `/uploads/*` -> `file-service:8082`
    *   **未配置代理 (问题点)**:
        *   `/api/user/*` (用户认证、商品、购物车)
        *   `/api/cart/*`
        *   `/api/user/orders/*`
        *   `/api/user/shipping/*`
        *   `/api/order/*`
        
        当前Nginx配置文件 (`docker/nginx/conf.d/default.conf`) **缺少**对上述用户端核心API的代理规则。这意味着在生产环境下，这些请求无法正确路由到 `shop-service:8083` 和 `order-service:8084`，会导致功能不可用。**Nginx配置急需更新。**

---

## 3. 技术选型

### 3.1 前端技术栈

| 技术         | 版本/说明                 | 作用                                     |
| :----------- | :------------------------ | :--------------------------------------- |
| Vue.js       | 3.x                       | 核心渐进式JavaScript框架                 |
| TypeScript   | 5.x (根据`tsconfig.json`) | 为JavaScript添加静态类型检查             |
| Vite         | 5.x (根据`package.json`)  | 下一代前端构建工具，提供极速的开发服务器 |
| Element Plus | 2.x (根据依赖)            | 基于Vue 3的桌面端UI组件库                |
| Pinia        | 2.x (根据依赖)            | Vue官方推荐的状态管理库                  |
| Vue Router   | 4.x                       | Vue.js官方路由管理器                     |
| Axios        | (根据`request.ts`)        | 基于Promise的HTTP客户端                  |

### 3.2 后端技术栈

各后端微服务普遍采用以下技术：

| 技术             | 版本/说明                                   | 作用                                     |
| :--------------- | :------------------------------------------ | :--------------------------------------- |
| Java             | 17 (根据Dockerfile)                         | 主要编程语言                             |
| Spring Boot      | (版本需在各模块`pom.xml`中确认)             | 用于快速构建独立的、生产级的Spring应用     |
| Spring Web MVC   | (Spring Boot内置)                           | 构建RESTful API                          |
| Spring Data JPA  | (可能，需检查`pom.xml`和Repository)         | 数据访问抽象层                           |
| MyBatis          | (订单服务`application.yml`中明确配置)       | SQL映射框架                              |
| Spring Security  | (商家订单控制器有`@PreAuthorize`，暗示使用) | 提供认证、授权和安全防护                 |
| Lombok           | (代码中广泛使用`@Slf4j`, `@Data`等)        | 减少Java样板代码的库                     |
| Slf4j            | (代码中广泛使用)                            | Java日志门面                             |
| Apache POI       | (`SpuInfoController`中使用)                 | 用于处理Microsoft Office格式文件 (Excel) |
| Jackson          | (Spring Boot内置)                           | 处理JSON序列化和反序列化                 |
| Swagger/OpenAPI  | (订单服务`UserOrderController`中使用注解)   | API文档生成和可视化                      |
| Maven            | (根据各模块`pom.xml`)                       | 项目构建和依赖管理工具                   |

### 3.3 中间件与数据库

| 技术    | 版本/说明 (基于`docker-compose.yml`) | 作用           |
| :------ | :----------------------------------- | :------------- |
| MySQL   | 8.0                                  | 关系型数据库   |
| Redis   | `latest` (实际可能是5.0.6或更高)     | 内存数据存储/缓存 |
| Nginx   | (前端Docker镜像内置)                 | Web服务器/反向代理 |

---

## 4. 后端服务模块详述

### 4.1 用户购物服务 (`shop-service` - 端口 8083)

该服务主要负责用户端的核心购物流程，包括用户账户、商品浏览和购物车功能。

#### 4.1.1 用户认证模块 (`UserAuthController`, `UserAuthService`)

*   **功能**: 提供用户注册、登录（验证码/密码）、密码重置、获取用户基本信息等功能。
*   **核心逻辑** (基于 `UserAuthServiceImpl`):
    *   **验证码处理**: 使用 `EmailService` 发送邮件验证码，并结合 `RedisUtil` 存储和校验有时效性的验证码 (如登录、重置密码场景)。注册验证码的校验逻辑似乎主要在 `EmailService` 内部。
    *   **密码加密**: 使用Spring Security的 `PasswordEncoder` 对用户密码进行加密存储和比对。
    *   **JWT**: 登录成功后，使用 `JwtUtil` 生成Access Token和Refresh Token，实现无状态认证。
    *   **数据操作**: 通过 `UserInfoRepository` 与数据库交互，进行用户信息的增删改查。
*   **主要API端点** (基路径 `/api/user/auth`):
    *   `POST /send-register-code`: 发送注册验证码。
    *   `POST /verify-register-code`: 校验注册验证码。
    *   `POST /register`: 用户注册。
    *   `POST /send-login-code`: 发送登录验证码。
    *   `POST /login`: 验证码登录。
    *   `POST /login/password`: 密码登录。
    *   `POST /send-reset-password-code`: 发送重置密码验证码。
    *   `POST /verify-reset-password-code`: 校验重置密码验证码。
    *   `POST /reset-password`: 重置密码。
    *   `GET /info/{userId}`: 获取用户信息。

#### 4.1.2 用户商品浏览模块 (`UserProductController`, `UserProductService`)

*   **功能**: 提供用户浏览商品分类、查看商品列表（推荐、热门、按分类、搜索）、获取商品详情等功能。
*   **核心逻辑** (基于 `UserProductServiceImpl`):
    *   **分类获取**: 从 `ProductCategoryRepository` 获取去重后的可见商品分类。
    *   **商品查询**: 主要通过 `SpuInfoRepository` 进行。
        *   推荐商品：按创建时间降序获取上架商品。
        *   热门商品：获取上架商品后，按展示价格降序模拟。
        *   搜索/列表/按分类查询：使用 `SpuInfoRepository.findByComplexConditions` 自定义方法进行复杂条件查询和分页。
    *   **数据填充**: `fillExtendedFields` 方法用于为商品列表填充分类名称和店铺名称（店铺名称当前为简单映射，待改进）。
*   **主要API端点** (基路径 `/api/user`):
    *   `GET /categories`: 获取所有商品分类。
    *   `GET /products/recommended`: 获取推荐商品。
    *   `GET /products/hot`: 获取热门商品。
    *   `GET /products/search`: 搜索商品 (支持关键词、分页、分类、价格、品牌、排序)。
    *   `GET /categories/{categoryId}/products`: 根据分类ID获取商品。
    *   `GET /products/{spuId}`: 获取SPU商品详情。
    *   `GET /products`: 通用商品列表查询接口。

#### 4.1.3 购物车模块 (`CartController`, `CartService`)

*   **功能**: 提供添加商品到购物车、查看购物车列表、修改商品数量、选择/取消选择商品、删除商品、清空购物车等功能。
*   **核心逻辑** (基于 `CartServiceImpl`):
    *   **添加商品**: 校验SKU库存 (`SkuInfoRepository.findAvailableSkuWithStock`)；如果购物车已存在该SKU则更新数量，否则新增。
    *   **列表获取/更新/删除**: 通过 `CartInfoRepository` 操作购物车数据，并进行用户权限校验。
    *   **数据转换**: `convertToResponseDTO` 方法用于将 `CartInfo` 转换为包含SKU和SPU详细信息（如价格、名称、图片）的 `CartItemResponseDTO`。
*   **主要API端点** (基路径 `/api/cart`):
    *   `POST /add`: 添加商品到购物车。
    *   `GET /list`: 获取购物车列表。
    *   `PUT /update`: 更新购物车项（数量/选中状态）。
    *   `DELETE /remove/{cartId}`: 删除购物车项。
    *   `DELETE /clear`: 清空购物车。
    *   `GET /count`: 获取购物车商品总数。
    *   `PUT /select`: 批量更新购物车项选中状态。
    *   `GET /selected`: 获取选中的购物车项。

### 4.2 商家服务 (`merchant-service` - 端口 8081)

该服务负责商家后台管理的核心功能。上下文路径为 `/merchant` (根据Nginx代理配置推断)。

#### 4.2.1 商家账户管理模块 (`MerchantController`, `MerchantService`)

*   **功能**: 提供商家注册、登录（验证码/密码）、商家信息获取与更新、密码修改与重置等。
*   **API基路径**: `/api/merchant` (完整路径 `/merchant/api/merchant`)
*   **核心逻辑**: 类似于用户认证模块，但针对商家实体 (`MerchantInfo`)，使用 `MerchantService` 处理业务，涉及验证码、密码加密、JWT等。
*   **主要API端点**:
    *   `POST /register`: 商家注册。
    *   `POST /send-login-code`, `POST /login`, `POST /login/password`: 商家登录相关。
    *   `GET /info/{merchantId}`, `PUT /info/{merchantId}`: 商家信息管理。
    *   `POST /change-password`, `POST /send-reset-password-code`, `POST /reset-password`: 密码管理。

#### 4.2.2 店铺管理模块 (`StoreController`, `StoreService`)

*   **功能**: 允许商家创建和管理自己的店铺信息。
*   **API基路径**: `/api/merchant/store` (完整路径 `/merchant/api/merchant/store`)
*   **核心逻辑**: 通过 `StoreService` 对店铺信息 (`StoreInfo` 实体) 进行CRUD操作。
*   **主要API端点**:
    *   `GET /list/{merchantId}`: 获取商家的店铺列表。
    *   `GET /{storeId}`: 获取店铺详情。
    *   `POST /create`: 创建店铺。
    *   `PUT /{storeId}`: 更新店铺信息。
    *   `DELETE /{storeId}`: 删除店铺。
    *   `GET /count/{merchantId}`: 获取商家店铺数量。

#### 4.2.3 商品SPU/SKU管理模块 (`SpuInfoController`, `SpuInfoService`, `SkuInfoService`)

*   **功能**: 提供商家对商品SPU和SKU的全面管理，包括创建、编辑、删除、上下架、批量操作、Excel导入等。
*   **API基路径**: `/api/merchant/spu` (完整路径 `/merchant/api/merchant/spu`)
*   **核心逻辑**:
    *   通过 `SpuInfoService` 和 `SkuInfoService` 管理 `SpuInfo` 和 `SkuInfo` 实体。
    *   **Excel导入/导出**: 使用Apache POI实现商品模板下载和Excel文件解析，支持批量导入商品数据。
    *   **SKU组合生成**: 提供根据基础属性动态生成SKU组合的功能。
*   **主要API端点**:
    *   SPU的CRUD: `POST /`, `GET /{spuId}`, `PUT /{spuId}`, `DELETE /{spuId}`。
    *   批量操作: `POST /batch`, `DELETE /batch-delete`, `POST /batch-publish`, `POST /batch-unpublish`。
    *   状态管理: `POST /{spuId}/publish`, `POST /{spuId}/unpublish`。
    *   其他: `GET /list` (列表查询), `GET /stats` (统计), `POST /{spuId}/copy` (复制)。
    *   SKU相关 (通过SPU路径): `GET /{spuId}/sku`, `POST /{spuId}/sku`。
    *   模板与导入: `GET /template/download`, `POST /parse-template`。
    *   SKU组合: `POST /generate-sku-combinations`。

#### 4.2.4 分类与属性管理模块 (`CategoryController`, `ProductCategoryService`, `CategoryAttributeService`)

*   **功能**: 允许商家管理店铺内的商品分类（层级结构）以及每个分类下的商品属性（基础属性、非基础属性、属性选项）。
*   **API基路径**: `/api/merchant/category` (完整路径 `/merchant/api/merchant/category`)
*   **核心逻辑**:
    *   `ProductCategoryService` 负责商品分类的CRUD、层级查询（树、子分类、叶子分类）、移动等。
    *   `CategoryAttributeService` 负责分类属性的CRUD、批量创建、类型管理等。
*   **主要API端点**:
    *   分类管理: `GET /tree/{storeId}`, `GET /top/{storeId}`, `GET /children/{storeId}/{parentId}`, `GET /leaf/{storeId}`, `GET /{categoryId}`, `POST /`, `PUT /{categoryId}`, `DELETE /{categoryId}`, `PUT /{categoryId}/move`。
    *   属性管理 (子路径 `/attribute`): `GET /attribute/category/{categoryId}`, `GET /attribute/{attributeId}`, `POST /attribute`, `PUT /attribute/{attributeId}`, `DELETE /attribute/{attributeId}`, `POST /attribute/batch`。
    *   辅助接口: `GET /{categoryId}/is-leaf`, `GET /attribute/category/{categoryId}/can-manage`, `GET /attribute/types`, `GET /{categoryId}/basic-attributes`, `GET /{categoryId}/non-basic-attributes`。

#### 4.2.5 商家订单管理模块 (`MerchantOrderController`, `MerchantOrderService`)

*   **功能**: 提供商家查看和管理其店铺订单的功能，如列表查询、查看详情、更新状态、发货、统计等。
*   **API基路径**: `/api/merchant/orders` (完整路径 `/merchant/api/merchant/orders`)
*   **权限**: 需要商家角色 (`@PreAuthorize("hasRole('MERCHANT')")`)。
*   **核心逻辑**: 通过 `MerchantOrderService` 处理。此服务可能需要与核心的订单服务 (`order-service`) 交互以获取和操作订单数据。
*   **主要API端点**:
    *   `GET /`: 获取商家订单列表 (分页、筛选)。
    *   `GET /{orderId}`: 获取订单详情。
    *   `PUT /{orderId}/status`: 更新订单状态。
    *   `POST /{orderId}/ship`: 订单发货。
    *   `GET /statistics`: 获取订单统计。

#### 4.2.6 其他控制器简述

*   **`DashboardController.java`**: (推测) 提供商家仪表盘所需的数据接口，如销售统计、待办事项等。
*   **`StoreExtendedController.java`**: (推测) 管理店铺的扩展信息或特定配置。
*   **`CategoryAttributeController.java`**, **`ProductCategoryController.java`**: 这两个文件的功能似乎已大部分体现在 `CategoryController.java` 中，可能存在代码组织上的调整或特定细分功能。

### 4.3 订单服务 (`order-service` - 端口 8084, 上下文路径 `/order`)

该服务独立负责用户订单处理和收货地址管理。

#### 4.3.1 用户订单模块 (`UserOrderController`, `UserOrderService`)

*   **功能**: 处理用户创建订单、查看订单列表与详情、取消订单、确认收货、模拟支付等。
*   **API基路径**: `/api/user/orders` (完整路径 `/order/api/user/orders`)
*   **核心逻辑**: 通过 `UserOrderService` 实现。涉及订单 (`OrderInfo`) 和订单项 (`OrderItem`) 的创建与状态流转。支付功能当前为模拟。
*   **主要API端点**:
    *   `POST /`: 创建订单。
    *   `GET /`: 获取用户订单列表。
    *   `GET /{orderId}`: 获取订单详情。
    *   `POST /{orderId}/cancel`: 取消订单。
    *   `POST /{orderId}/confirm-receipt`: 确认收货。
    *   `POST /{orderId}/pay`: （模拟）支付订单。

#### 4.3.2 收货地址管理模块 (`ShippingInfoController`, `ShippingInfoService`)

*   **功能**: 允许用户创建、查看、更新、删除自己的收货地址，并设置默认地址。
*   **API基路径**: `/api/user/shipping` (完整路径 `/order/api/user/shipping`)
*   **核心逻辑**: 通过 `ShippingInfoService` 管理 `ShippingInfo` 实体。操作时会通过 `SecurityUtils.getCurrentUserId()` 获取当前用户ID，确保数据归属和操作权限。
*   **主要API端点**:
    *   `POST /`: 创建收货地址。
    *   `GET /`: 获取用户收货地址列表。
    *   `GET /{id}`: 获取收货地址详情。
    *   `PUT /{id}`: 更新收货地址。
    *   `DELETE /{id}`: 删除收货地址。
    *   `POST /{id}/default`: 设置默认地址。

### 4.4 文件服务 (`file-service` - 端口 8082)

该服务专注于文件（主要是图片）的上传和管理。

#### 4.4.1 文件上传模块 (`FileUploadController`, `FileUploadService`)

*   **功能**: 提供图片上传接口和文件删除接口。
*   **API基路径**: `/api/upload`
*   **核心逻辑**:
    *   通过 `FileUploadService` 实现。
    *   上传接口包含文件类型（MIME）、大小校验。
    *   `type` 参数用于对上传文件进行分类存储（如logo、product）。
    *   删除接口根据文件URL进行删除。
*   **主要API端点**:
    *   `POST /image`: 上传图片。
    *   `DELETE /delete`: 删除文件。

---

## 5. 前端项目说明 (`ecommerce-frontend`)

前端项目采用现代化的技术栈，旨在提供流畅的用户体验和高效的开发流程。

### 5.1 项目结构与构建 (Vite)

*   **源代码目录**: `front_end/ecommerce-frontend/src`。
*   **构建工具**: Vite (`vite.config.ts`)。
    *   提供快速的冷启动和热模块替换 (HMR)。
    *   配置了路径别名 (`@` 指向 `src`)。
    *   **开发环境代理**: `server.proxy` 配置了对各个后端微服务的API代理规则，解决了开发时的跨域问题，并能模拟生产环境的API路径结构。
*   **核心目录结构**:
    *   `api/`: 封装对后端API的调用，按业务模块划分 (e.g., `user/order.ts`, `merchant/product.ts`)。
    *   `assets/`: 静态资源。
    *   `components/`: 可复用的UI组件。
    *   `router/`: Vue Router的路由配置。
    *   `store/`: Pinia状态管理模块。
    *   `views/`: 页面级组件。

### 5.2 路由配置 (`src/router/index.ts`)

*   使用 `vue-router` 进行单页应用 (SPA) 的路由管理。
*   采用 `createWebHistory` HTML5历史模式。
*   **路由划分**:
    *   用户端路由 (e.g., `/home`, `/user/login`, `/product/:id`, `/cart`, `/checkout`, `/user/orders`)。
    *   商家端路由 (e.g., `/merchant/login`, `/merchant/dashboard`, `/merchant/category/:categoryId/attributes`)。
    *   测试路由 (e.g., `/test/api`)。
*   **路由守卫 (`router.beforeEach`)**:
    *   用于实现认证拦截。
    *   检查目标路由是否需要商家登录权限。
    *   如果需要但未登录或Token过期，则重定向到商家登录页。

### 5.3 状态管理 (Pinia)

*   使用Pinia (`src/store/modules/`) 进行全局状态管理。
*   **`auth.ts`**: 管理商家端的认证状态（登录状态、Token、用户信息、登出逻辑）。
*   **`userAuth.ts`**: (预期) 管理用户端的认证状态。

### 5.4 API请求封装 (`src/utils/request.ts`)

*   基于Axios封装了统一的HTTP请求函数。
*   **`baseURL: ''`**: 在开发环境依赖Vite代理，在生产环境依赖Nginx代理（当前Nginx配置不完整）。
*   **请求拦截器**:
    *   自动根据API路径（`/api/merchant/` 或 `/api/user/`, `/api/cart/`）添加对应的JWT认证Token到请求头 (`Authorization: Bearer <token>`)。用户Token从localStorage获取。
    *   包含详细的请求日志输出。
*   **响应拦截器**:
    *   统一处理API响应，包括成功和错误情况。
    *   对常见的HTTP错误状态码（401, 403, 404, 500）进行统一处理，并使用Element Plus的 `ElMessage` 进行提示。
    *   包含详细的响应日志输出。

### 5.5 (核心视图组件概览)

*   **用户端 (`src/views/user/`)**:
    *   [`home/index.vue`](front_end/ecommerce-frontend/src/views/user/home/index.vue:1): 首页，展示商品、分类等。
    *   `product/detail.vue`: 商品详情页。
    *   `cart/index.vue`: 购物车。
    *   `checkout/index.vue`: 结算页。
    *   `orders/index.vue` & `orders/detail.vue`: 订单列表与详情。
*   **商家端 (`src/views/merchant/`)**:
    *   `dashboard/index.vue`: 商家仪表盘。
    *   `login/index.vue`: 商家登录。
    *   `product/ProductManagement.vue` (可能): 商品管理界面。
    *   `order-management/index.vue`: 商家订单管理界面。

---
## 6. 数据库设计

系统使用MySQL数据库。以下是根据 [`docker/mysql/init/02-business-tables.sql`](docker/mysql/init/02-business-tables.sql:1) 文件分析的核心表结构：

### 6.1 `user_info` (用户信息表)
存储用户的基本注册和登录信息。
*   `user_id` (INT UNSIGNED, PK, AI): 用户唯一标识。
*   `username` (VARCHAR(20), NN, UK): 用户名，唯一。
*   `email` (VARCHAR(255), NN, UK): 用户邮箱，唯一，用于登录和接收通知。
*   `password` (VARCHAR(255), NN): 加密后的用户密码。
*   `gender` (CHAR(1)): 性别。
*   `avatar_url` (VARCHAR(255), DEFAULT 'default_avatar_url'): 用户头像链接。

### 6.2 `shipping_info` (收货地址表)
存储用户的收货地址信息。
*   `shipping_id` (INT UNSIGNED, PK, AI): 收货地址唯一标识。
*   `user_id` (INT UNSIGNED, NN, IDX): 关联到 `user_info` 表的用户ID。
*   `receiver_name` (VARCHAR(20), NN): 收货人姓名。
*   `receiver_phone` (VARCHAR(11), NN): 收货人手机号。
*   `province`, `city`, `district` (VARCHAR(20), NN): 省、市、区/县。
*   `detail_address` (VARCHAR(100), NN): 详细街道地址。
*   `is_default` (TINYINT(1), NN, DEFAULT 0): 是否为默认收货地址 (0:否, 1:是)。

### 6.3 `merchant_info` (商家基础信息表)
存储商家的注册信息和资质信息。
*   `merchant_id` (INT UNSIGNED, PK, AI): 商家唯一标识。
*   `merchant_name` (VARCHAR(20), NN, UK): 商家名称，唯一。
*   `phone_number` (VARCHAR(11), UK): 商家手机号，唯一。
*   `email` (VARCHAR(255), NN, UK): 商家邮箱，唯一，用于登录。
*   `password` (VARCHAR(255), NN): 加密后的商家登录密码。
*   `merchant_type` (ENUM('enterprise', 'individual'), NN): 商家类型（企业/个体）。
*   `business_license_no` (CHAR(18), NN, UK): 营业执照编号（统一社会信用代码），唯一。
*   `legal_person_name` (VARCHAR(16), NN): 法人姓名。
*   `legal_person_id_card` (CHAR(18), NN, UK): 法人身份证号，唯一。
*   `contact_person_name`, `contact_phone`, `contact_email`: 商家联系人信息。
*   `province`, `city`, `county`, `district`, `detailed_address`: 商家地址信息。

### 6.4 `store_info` (店铺信息表)
存储商家开设的店铺详细信息。
*   `store_id` (INT UNSIGNED, PK, AI): 店铺唯一标识。
*   `merchant_id` (INT UNSIGNED, NN, IDX): 关联到 `merchant_info` 表的商家ID。
*   `store_name` (VARCHAR(50), NN): 店铺名称。
*   `store_logo` (VARCHAR(255)): 店铺Logo图片链接。
*   `store_description` (TEXT): 店铺描述。
*   `category` (VARCHAR(50)): 店铺主营类目。
*   `service_promise` (JSON): 服务承诺，以JSON数组形式存储。
*   `service_phone`, `service_email`: 店铺客服联系方式。
*   `business_hours` (VARCHAR(100)): 营业时间。
*   `open_time` (TIMESTAMP, NN, DEFAULT CURRENT_TIMESTAMP): 开店时间。
*   `status` (ENUM('open', 'closed', 'suspended'), NN, DEFAULT 'open'): 店铺状态。
*   `credit_score` (INT, NN, DEFAULT 100): 店铺信用分。
*   `create_time`, `update_time`: 时间戳。

### 6.5 `settlement_info` (结算信息表)
存储商家的结算账户信息。
*   `settlement_id` (INT UNSIGNED, PK, AI): 结算信息唯一标识。
*   `merchant_id` (INT UNSIGNED, NN, IDX): 关联到 `merchant_info` 表的商家ID。
*   `bank_name` (VARCHAR(50), NN): 开户银行名称。
*   `bank_account` (VARCHAR(20), NN): 银行账号。
*   `account_name` (VARCHAR(50), NN): 开户名。
*   `settlement_cycle` (ENUM('daily', 'weekly', 'monthly'), NN, DEFAULT 'monthly'): 结算周期。
*   `commission_rate` (DECIMAL(5,2), NN, DEFAULT 5.00): 平台佣金比例 (%)。

### 6.6 `product_category` (商品分类表)
存储商家店铺内的商品分类信息，支持层级结构。
*   `category_id` (INT UNSIGNED, PK, AI): 分类唯一标识。
*   `store_id` (INT UNSIGNED, NN, IDX, FK to `store_info`): 关联到 `store_info` 表的店铺ID。
*   `parent_id` (INT UNSIGNED, DEFAULT NULL, IDX): 父分类ID，用于构建层级关系。顶级分类此字段为NULL。
*   `category_name` (VARCHAR(50), NN): 分类名称。在同一店铺下，分类名称应唯一 (`uk_store_category_name`)。
*   `description` (VARCHAR(50)): 分类描述。
*   `category_level` (TINYINT, NN): 分类层级。
*   `sort_order` (INT, NN, DEFAULT 0): 排序字段。
*   `is_visible` (TINYINT(1), NN, DEFAULT 1): 是否可见 (0:否, 1:是)。
*   `icon_url` (VARCHAR(255)): 分类图标链接。
*   `create_time`: 时间戳。

### 6.7 `category_attribute` (分类属性表)
存储商品分类关联的属性定义。
*   `attribute_id` (INT UNSIGNED, PK, AI): 属性唯一标识。
*   `store_id` (INT UNSIGNED, NN, IDX, FK to `store_info`): 关联店铺ID。
*   `category_id` (INT UNSIGNED, NN, IDX, FK to `product_category`): 关联分类ID。
*   `attribute_name` (VARCHAR(50), NN): 属性名称。在同一店铺的同一分类下，属性名应唯一 (`uk_store_category_attribute`)。
*   `attribute_type` (ENUM('TEXT', 'NUMBER', 'DATE', 'BOOLEAN', 'ENUM'), NN): 属性类型。
*   `is_basic_attribute` (TINYINT(1), NN, DEFAULT 0): 是否为基础属性 (通常用于生成SKU)。
*   `is_required` (TINYINT(1), NN, DEFAULT 0): 该属性是否必填。

### 6.8 `attribute_option` (属性可选值表)
当分类属性类型为 `ENUM` 时，此表存储其可选值。
*   `option_id` (INT UNSIGNED, PK, AI): 选项唯一标识。
*   `attribute_id` (INT UNSIGNED, NN, IDX, FK to `category_attribute`): 关联属性ID。
*   `option_value` (VARCHAR(50), NN): 选项的具体值。

### 6.9 `spu_info` (商品SPU表 - Standard Product Unit)
存储商品的标准化信息单元。
*   `product_id` (INT UNSIGNED, PK, AI): SPU唯一标识。
*   `merchant_id` (INT UNSIGNED, NN, IDX): 关联商家ID。
*   `store_id` (INT UNSIGNED, NN, IDX): 关联店铺ID。
*   `category_id` (INT UNSIGNED, NN, IDX): 关联的叶子节点分类ID。
*   `product_name` (VARCHAR(20), NN): 商品名称。在同一店铺下，商品名应唯一 (`uk_store_product_name`)。
*   `description` (VARCHAR(100)): 商品描述。
*   `image_url` (LONGTEXT): 商品主图片链接或Base64数据。
*   `display_price` (DECIMAL(10,2), NN): 商品的展示价格（可能不是实际SKU售价）。
*   `basic_attributes` (JSON, NN): 基础属性值（键值对，如 `{"颜色": "红色", "尺寸": "L"}`）。
*   `non_basic_attributes` (JSON, NN): 非基础属性值。
*   `brand_name` (VARCHAR(50)): 品牌名称。
*   `selling_point` (TEXT): 商品卖点描述。
*   `unit` (VARCHAR(10), NN, DEFAULT '件'): 计量单位。
*   `status` (VARCHAR(20), NN, DEFAULT 'draft'): 商品状态 (draft-草稿, on_shelf-上架, off_shelf-下架)。
*   `create_time`, `update_time`: 时间戳。

### 6.10 `sku_info` (商品SKU表 - Stock Keeping Unit)
存储商品的库存量单位信息，是实际销售的单元。
*   `sku_id` (INT UNSIGNED, PK, AI): SKU唯一标识。
*   `product_id` (INT UNSIGNED, NN, IDX, FK to `spu_info`): 关联的SPU ID。
*   `sku_name` (VARCHAR(255), NN): SKU名称，通常由SPU名称和关键属性值组合而成。在同一SPU下，SKU名称应唯一 (`uk_sku_name_spu`)。
*   `sale_price` (DECIMAL(10,2), NN, DEFAULT 0.00): SKU的实际销售价格。
*   `stock_quantity` (INT UNSIGNED, NN, DEFAULT 0): 当前库存数量。
*   `attribute_combination` (JSON, NN): 该SKU具体的属性值组合（由后端生成，如 `{"颜色": "红色", "尺寸": "L"}`）。
*   `status` (TINYINT, NN, DEFAULT 2): SKU状态 (1-上架, 2-下架, 3-库存不足)。
*   `exclusive_image_url` (LONGTEXT): SKU专属图片链接，若无则使用SPU图片。
*   `warn_stock` (INT UNSIGNED, NN, DEFAULT 10): 库存警告阈值。
*   `create_time`, `update_time`: 时间戳。

### 6.11 `cart_info` (购物车表)
存储用户的购物车信息。
*   `cart_id` (INT UNSIGNED, PK, AI): 购物车项唯一标识。
*   `user_id` (INT UNSIGNED, NN, IDX): 关联用户ID。
*   `sku_id` (INT UNSIGNED, NN, UK with `user_id`): 关联的SKU ID。同一用户购物车中SKU应唯一 (`uk_user_sku`)。
*   `quantity` (INT, NN, DEFAULT 1): 商品数量。
*   `is_selected` (TINYINT(1), NN, DEFAULT 1): 是否选中用于结算 (0:否, 1:是)。
*   `create_time`, `update_time`: 时间戳。

### 6.12 `order_info` (订单信息表)
存储订单的总体信息。
*   `order_id` (INT UNSIGNED, PK, AI): 订单唯一标识。
*   `order_no` (VARCHAR(50), NN, UK): 订单编号，唯一。
*   `user_id` (INT UNSIGNED, NN, IDX): 关联用户ID。
*   `store_id` (INT UNSIGNED, NN, IDX): 关联店铺ID。
*   `shipping_id` (INT UNSIGNED, NN): 关联的收货地址ID (`shipping_info.shipping_id`)。
*   `total_amount` (DECIMAL(10,2), NN): 订单总金额（商品金额 + 运费 - 优惠）。
*   `actual_amount` (DECIMAL(10,2), NN): 用户实际支付金额。
*   `discount_amount` (DECIMAL(10,2), NN, DEFAULT 0.00): 优惠金额。
*   `shipping_fee` (DECIMAL(10,2), NN, DEFAULT 0.00): 运费。
*   `order_status` (ENUM('pending_payment', 'pending_shipment', 'pending_receipt', 'completed', 'cancelled', 'refunded'), NN, DEFAULT 'pending_payment'): 订单状态。
*   `payment_method` (ENUM('alipay', 'wechat', 'credit_card', 'cod')): 支付方式。
*   `order_note` (VARCHAR(255)): 用户订单备注。
*   `order_items` (JSON, NN): 订单项快照，以JSON格式存储（包含SKU ID, 名称, 图片, 价格, 数量等）。
*   `create_time`, `pay_time`, `ship_time`, `complete_time`, `cancel_time`, `update_time`: 各种状态的时间戳。

### 6.13 `logistics_info` (物流信息表)
存储订单的物流配送信息。
*   `logistics_id` (INT UNSIGNED, PK, AI): 物流信息唯一标识。
*   `order_id` (INT UNSIGNED, NN, UK, FK to `order_info`): 关联订单ID，唯一。
*   `shipping_company` (VARCHAR(50), NN): 快递公司名称。
*   `tracking_number` (VARCHAR(50), NN, IDX): 快递单号。
*   `ship_time` (TIMESTAMP, NN, DEFAULT CURRENT_TIMESTAMP): 发货时间。
*   `logistics_status` (ENUM('not_shipped', 'waiting_pickup', 'in_transit', 'delivered', 'rejected'), NN, DEFAULT 'not_shipped'): 物流状态。
*   `logistics_info` (JSON): 物流轨迹详情，以JSON格式存储。
*   `delivery_time` (TIMESTAMP): 送达时间。
*   `sign_name` (VARCHAR(50)): 签收人姓名。
*   `create_time`, `update_time`: 时间戳。

### 6.14 `payment_info` (支付信息表)
存储订单的支付相关信息。
*   `payment_id` (INT UNSIGNED, PK, AI): 支付信息唯一标识。
*   `order_id` (INT UNSIGNED, NN, UK, FK to `order_info`): 关联订单ID，唯一。
*   `payment_status` (ENUM('unpaid', 'paid', 'partially_paid', 'payment_failed', 'refunding', 'refunded'), NN): 支付状态。
*   `payment_time` (TIMESTAMP): 支付成功时间。
*   `payment_method` (VARCHAR(50)): 实际支付方式。
*   `actual_amount` (DECIMAL(10,2)): 实际支付金额。
*   `transaction_id` (VARCHAR(255), UK): 第三方支付平台返回的交易流水号，唯一。

---
## 7. API接口文档 (核心接口)

**注意：** 以下API路径是基于各服务模块的控制器 `@RequestMapping` 和方法映射。在生产环境中，这些路径需要通过Nginx正确代理。服务名称和端口基于 `docker-compose.yml` 和Vite代理配置。

*   `shop-service`: 运行在 `8083` 端口，无特定上下文路径。
*   `merchant-service`: 运行在 `8081` 端口，上下文路径 `/merchant`。
*   `order-service`: 运行在 `8084` 端口，上下文路径 `/order`。
*   `file-service`: 运行在 `8082` 端口，无特定上下文路径。

### 7.1 用户认证API (`shop-service` - 基路径 `/api/user/auth`)
*   **`POST /send-register-code`**: 发送注册验证码。
    *   请求体: `{ "email": "user@example.com" }`
*   **`POST /verify-register-code`**: 校验注册验证码。
    *   请求体: `{ "email": "user@example.com", "verificationCode": "123456" }`
*   **`POST /register`**: 用户注册。
    *   请求体: `UserRegisterDTO` (`username`, `email`, `password`, `gender`, `avatarUrl`, `verificationCode`)
*   **`POST /send-login-code`**: 发送登录验证码。
    *   请求体: `{ "email": "user@example.com" }`
*   **`POST /login`**: 验证码登录。
    *   请求体: `UserLoginDTO` (`email`, `verificationCode`)
*   **`POST /login/password`**: 密码登录。
    *   请求体: `UserPasswordLoginDTO` (`email`, `password`)
*   **`POST /send-reset-password-code`**: 发送重置密码验证码。
*   **`POST /verify-reset-password-code`**: 校验重置密码验证码。
*   **`POST /reset-password`**: 重置密码。
*   **`GET /info/{userId}`**: 获取用户信息。

### 7.2 用户商品API (`shop-service` - 基路径 `/api/user`)
*   **`GET /categories`**: 获取所有商品分类。
*   **`GET /products/recommended`**: 获取推荐商品 (参数: `limit`)。
*   **`GET /products/hot`**: 获取热门商品 (参数: `limit`)。
*   **`GET /products/search`**: 搜索商品 (参数: `keyword`, `page`, `pageSize`, `categoryId`, `minPrice`, `maxPrice`, `brandName`, `sortBy`, `sortOrder`)。
*   **`GET /categories/{categoryId}/products`**: 根据分类ID获取商品。
*   **`GET /products/{spuId}`**: 获取SPU商品详情。
*   **`GET /products`**: 通用商品列表查询。

### 7.3 购物车API (`shop-service` - 基路径 `/api/cart`)
*   **`POST /add`**: 添加商品到购物车 (请求体: `CartAddDTO` - `skuId`, `quantity`)。
*   **`GET /list`**: 获取购物车列表。
*   **`PUT /update`**: 更新购物车项 (请求体: `CartUpdateDTO` - `cartId`, `quantity` (可选), `isSelected` (可选))。
*   **`DELETE /remove/{cartId}`**: 删除购物车项。
*   **`DELETE /clear`**: 清空购物车。
*   **`GET /count`**: 获取购物车商品总数。
*   **`PUT /select`**: 批量更新购物车项选中状态 (参数: `cartIds`, `isSelected`)。
*   **`GET /selected`**: 获取选中的购物车项。

### 7.4 用户订单API (`order-service` - 基路径 `/order/api/user/orders`)
*   **`POST /`**: 创建订单 (请求体: `CreateOrderDTO`)。
*   **`GET /`**: 获取用户订单列表 (参数: `pageNum`, `pageSize`, `orderNo`, `orderStatus`)。
*   **`GET /{orderId}`**: 获取订单详情。
*   **`POST /{orderId}/cancel`**: 取消订单。
*   **`POST /{orderId}/confirm-receipt`**: 确认收货。
*   **`POST /{orderId}/pay`**: (模拟)支付订单 (参数: `paymentMethod`)。

### 7.5 收货地址API (`order-service` - 基路径 `/order/api/user/shipping`)
*   **`POST /`**: 创建收货地址 (请求体: `ShippingInfo` 实体)。
*   **`GET /`**: 获取用户收货地址列表。
*   **`GET /{id}`**: 获取收货地址详情。
*   **`PUT /{id}`**: 更新收货地址 (请求体: `ShippingInfo` 实体)。
*   **`DELETE /{id}`**: 删除收货地址。
*   **`POST /{id}/default`**: 设置默认地址。

### 7.6 商家账户API (`merchant-service` - 基路径 `/merchant/api/merchant`)
*   **`POST /register`**: 商家注册 (请求体: `MerchantRegisterDTO`)。
*   **`POST /send-login-code`**: 发送商家登录验证码。
*   **`POST /login`**: 商家验证码登录 (请求体: `MerchantLoginDTO`)。
*   **`POST /login/password`**: 商家密码登录 (请求体: `MerchantPasswordLoginDTO`)。
*   **`GET /info/{merchantId}`**: 获取商家信息。
*   **`PUT /info/{merchantId}`**: 更新商家信息 (请求体: `MerchantProfileDTO`)。
*   **`POST /change-password`**: 修改商家密码 (请求体: `MerchantPasswordChangeDTO`)。
*   **`POST /send-reset-password-code`**: 发送商家重置密码验证码。
*   **`POST /verify-reset-password-code`**: 校验商家重置密码验证码。
*   **`POST /reset-password`**: 商家重置密码 (请求体: `MerchantResetPasswordDTO`)。

### 7.7 店铺管理API (`merchant-service` - 基路径 `/merchant/api/merchant/store`)
*   **`GET /list/{merchantId}`**: 获取商家的店铺列表。
*   **`GET /{storeId}`**: 获取店铺详情。
*   **`POST /create`**: 创建店铺 (请求体: `Map` - `merchantId`, `storeName`, `storeLogo`, `storeDescription`)。
*   **`PUT /{storeId}`**: 更新店铺信息 (请求体: `Map` - `storeName`, `storeLogo`, `storeDescription`, `status`)。
*   **`DELETE /{storeId}`**: 删除店铺。
*   **`GET /count/{merchantId}`**: 获取商家店铺数量。

### 7.8 商品SPU/SKU API (`merchant-service` - 基路径 `/merchant/api/merchant/spu`)
*   **`POST /`**: 创建SPU (请求体: `SpuCreateDTO`)。
*   **`POST /batch`**: 批量创建SPU (请求体: `List<SpuCreateDTO>`)。
*   **`GET /template/download`**: 下载Excel导入模板。
*   **`POST /parse-template`**: 解析上传的Excel模板 (参数: `file`, `storeId`)。
*   **`GET /{spuId}`**: 获取SPU详情。
*   **`PUT /{spuId}`**: 更新SPU (请求体: `SpuCreateDTO`)。
*   **`DELETE /{spuId}`**: 删除SPU。
*   **`DELETE /batch-delete`**: 批量删除SPU (请求体: `{ "spuIds": [...] }`)。
*   **`GET /list` (或 `GET /`)**: 分页查询SPU列表 (参数: `storeId`, `categoryId`, `keyword`, `status`, `page`, `pageSize`, `sortBy`, `sortOrder`)。
*   **`GET /stats`**: 获取SPU统计 (参数: `storeId`)。
*   **`POST /{spuId}/publish`**: 上架SPU。
*   **`POST /{spuId}/unpublish`**: 下架SPU。
*   **`POST /batch-publish`**: 批量上架SPU (请求体: `{ "spuIds": [...] }`)。
*   **`POST /batch-unpublish`**: 批量下架SPU (请求体: `{ "spuIds": [...] }`)。
*   **`POST /{spuId}/copy`**: 复制SPU (请求体: `{ "newName": "..." }`)。
*   **`POST /generate-sku-combinations`**: 生成SKU组合 (请求体: `{ "basicAttributes": {...} }`)。
*   **`GET /{spuId}/sku`**: 获取SPU下的SKU列表。
*   **`POST /{spuId}/sku`**: 为SPU创建SKU (请求体: `SkuCreateDTO`)。

### 7.9 分类与属性API (`merchant-service` - 基路径 `/merchant/api/merchant/category`)
*   **分类管理**:
    *   `GET /tree/{storeId}`: 获取分类树。
    *   `GET /top/{storeId}`: 获取顶级分类。
    *   `GET /children/{storeId}/{parentId}`: 获取子分类。
    *   `GET /leaf/{storeId}`: 获取叶子分类。
    *   `GET /{categoryId}`: 获取分类详情。
    *   `POST /`: 创建分类 (请求体: `CreateCategoryRequest`)。
    *   `PUT /{categoryId}`: 更新分类 (请求体: `UpdateCategoryRequest`)。
    *   `DELETE /{categoryId}`: 删除分类。
    *   `PUT /{categoryId}/move`: 移动分类 (参数: `newParentId`)。
    *   `GET /{categoryId}/is-leaf`: 检查是否为叶子分类。
*   **属性管理** (子路径 `/attribute`):
    *   `GET /attribute/category/{categoryId}`: 获取分类的属性。
    *   `GET /attribute/{attributeId}`: 获取属性详情。
    *   `POST /attribute`: 创建属性 (请求体: `CreateAttributeRequest`)。
    *   `PUT /attribute/{attributeId}`: 更新属性 (请求体: `UpdateAttributeRequest`)。
    *   `DELETE /attribute/{attributeId}`: 删除属性。
    *   `POST /attribute/batch`: 批量创建属性 (请求体: `BatchCreateAttributesRequest`)。
    *   `GET /attribute/category/{categoryId}/can-manage`: 检查分类是否可管理属性。
    *   `GET /attribute/types`: 获取属性类型列表。
    *   `GET /{categoryId}/basic-attributes`: 获取分类的基础属性。
    *   `GET /{categoryId}/non-basic-attributes`: 获取分类的非基础属性。

### 7.10 商家订单API (`merchant-service` - 基路径 `/merchant/api/merchant/orders`)
*   **`GET /`**: 获取商家订单列表 (参数: `pageNum`, `pageSize`, `orderNo`, `orderStatus`, `startDate`, `endDate`)。
*   **`GET /{orderId}`**: 获取订单详情。
*   **`PUT /{orderId}/status`**: 更新订单状态 (请求体: `UpdateOrderStatusDTO`)。
*   **`POST /{orderId}/ship`**: 订单发货 (请求体: `ShipOrderDTO`)。
*   **`GET /statistics`**: 获取订单统计。

### 7.11 文件上传API (`file-service` - 基路径 `/api/upload`)
*   **`POST /image`**: 上传图片 (参数: `file`, `type`)。
*   **`DELETE /delete`**: 删除文件 (请求体: `{ "url": "..." }`)。

---
## 8. Docker容器化部署与运维

项目通过 Docker 和 Docker Compose 进行容器化部署。

### 8.1 Docker Compose 配置分析 (`docker-compose.yml`)

[`docker-compose.yml`](docker-compose.yml:1) 文件定义了以下服务：

*   **`mysql`**:
    *   镜像: `swr.cn-north-4.myhuaweicloud.com/library/mysql:8.0`
    *   端口: `3306:3306`
    *   环境变量: `MYSQL_ROOT_PASSWORD`, `MYSQL_DATABASE` (`shopping_ecommerce`), `MYSQL_USER` (`shopping`), `MYSQL_PASSWORD` (`shopping123`)。
    *   卷挂载:
        *   `mysql_data:/var/lib/mysql` (数据持久化)
        *   `./docker/mysql/init:/docker-entrypoint-initdb.d` (初始化脚本)
        *   `./docker/mysql/conf:/etc/mysql/conf.d` (自定义配置)
    *   健康检查: 通过 `mysqladmin ping`。
*   **`redis`**:
    *   镜像: `swr.cn-north-4.myhuaweicloud.com/library/redis:latest`
    *   端口: `6379:6379`
    *   卷挂载:
        *   `redis_data:/data` (数据持久化)
        *   `./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf` (自定义配置)
    *   健康检查: 通过 `redis-cli ping`。
*   **`merchant-service`**:
    *   构建: 上下文 `./back_end/parent-project/merchant`, Dockerfile `Dockerfile`。
    *   端口: `8081:8081`。
    *   环境变量: `SPRING_PROFILES_ACTIVE=prod`, `JAVA_OPTS`, 数据库和Redis连接信息 (指向Docker网络中的`mysql`和`redis`服务)。
    *   卷挂载: `./logs/merchant-service:/app/logs`。
    *   依赖: `mysql`, `redis` (带健康检查条件)。
    *   健康检查: `curl http://localhost:8081/merchant/actuator/health` (注意: Nginx代理规则显示其上下文路径为 `/merchant`，因此健康检查URL应为 `http://localhost:8081/merchant/actuator/health`)。
*   **`file-service`**:
    *   构建: 上下文 `./back_end/parent-project/file`, Dockerfile `Dockerfile` (实际Dockerfile可能在 `docker/file-service/Dockerfile`)。
    *   端口: `8082:8082`。
    *   环境变量: `SPRING_PROFILES_ACTIVE=docker`, `JAVA_OPTS`, 数据库和Redis连接信息。
    *   卷挂载: `./logs/file-service:/app/logs`, `./uploads:/app/uploads`。
    *   依赖: `mysql`, `redis`。
    *   健康检查: `curl http://localhost:8082/actuator/health`。
*   **`shop-service`**:
    *   构建: 上下文 `./back_end/parent-project/shop`, Dockerfile `Dockerfile`。
    *   端口: `8083:8083`。
    *   环境变量: `SPRING_PROFILES_ACTIVE=docker`, `JAVA_OPTS`, `TZ`。**注意：此服务也需要数据库和Redis连接信息，但未在`docker-compose.yml`中显式配置，可能依赖于其打包的`application-docker.yml`或默认配置能从环境中获取。**
    *   卷挂载: `./logs/shop-service:/app/logs`。
    *   健康检查: `curl http://localhost:8083/actuator/health`。
*   **`frontend`**:
    *   构建: 上下文 `./front_end/ecommerce-frontend`, Dockerfile `Dockerfile`。
    *   端口: `3000:80` (将主机的3000端口映射到Nginx容器的80端口)。
    *   环境变量: Nginx相关配置，以及代理后端的服务名和端口 (`BACKEND_HOST=merchant-service`, `FILE_SERVICE_HOST=file-service`)。
    *   卷挂载: Nginx配置文件 (`./docker/nginx/nginx.conf`, `./docker/nginx/conf.d`) 和日志 (`./logs/nginx`)。
    *   依赖: `merchant-service`, `file-service`。
    *   健康检查: `curl http://localhost/health` (Nginx自身健康检查端点)。
*   **数据卷 (`volumes`)**: `mysql_data`, `redis_data` 使用本地驱动。
*   **网络 (`networks`)**: `shopping-network` 自定义桥接网络。

**缺失的服务**:
*   **`order-service`**: 根据Vite配置和`order`模块的`application.yml`，订单服务运行在`8084`端口，上下文路径`/order`。此服务**未在 `docker-compose.yml` 中定义**，是生产部署的一个主要缺失环节。

### 8.2 各服务Dockerfile分析

#### 8.2.1 `merchant-service` Dockerfile ([`back_end/parent-project/merchant/Dockerfile`](back_end/parent-project/merchant/Dockerfile:1))
*   基础镜像: 华为云 OpenJDK 17 (`swr.cn-north-4.myhuaweicloud.com/shopping-ecommerce/openjdk:17-jdk`)。
*   复制 `target/*.jar` 为 `app.jar`。
*   创建并使用非root用户 `appuser`。
*   暴露端口 `8081`。
*   健康检查: `curl -f http://localhost:8081/actuator/health || exit 1` (应为 `/merchant/actuator/health` 以匹配上下文路径)。
*   启动命令: `java $JAVA_OPTS -Djava.security.egd=file:/dev/./urandom -jar app.jar`。

#### 8.2.2 `file-service` Dockerfile ([`docker/file-service/Dockerfile`](docker/file-service/Dockerfile:1))
*   基础镜像: 华为云 OpenJDK 17。
*   复制 `target/*.jar` 为 `app.jar`。
*   创建并使用非root用户 `appuser`。
*   创建 `/app/uploads` 目录用于文件存储。
*   暴露端口 `8082`。
*   健康检查: `curl -f http://localhost:8082/actuator/health || exit 1`。
*   启动命令: `java -Djava.security.egd=file:/dev/./urandom -Dspring.profiles.active=docker -jar app.jar`。

#### 8.2.3 `shop-service` Dockerfile ([`back_end/parent-project/shop/Dockerfile`](back_end/parent-project/shop/Dockerfile:1))
*   基础镜像: `openjdk:17-jdk-slim`。
*   复制 `target/shop-*.jar` 为 `app.jar`。
*   安装 `curl` 用于健康检查 (但Dockerfile本身未定义`HEALTHCHECK`指令，依赖`docker-compose.yml`中的配置)。
*   暴露端口 `8083`。
*   启动命令: `java -jar /app/app.jar`。

#### 8.2.4 `frontend` Dockerfile ([`front_end/ecommerce-frontend/Dockerfile`](front_end/ecommerce-frontend/Dockerfile:1))
*   **多阶段构建**:
    *   **构建阶段 (`build`)**:
        *   基础镜像: `swr.cn-north-4.myhuaweicloud.com/shopping-ecommerce/node:18-alpine`。
        *   设置NPM淘宝镜像源。
        *   安装依赖 (`npm install`)。
        *   构建项目 (`npx vite build`)，产物在 `/app/dist`。
    *   **生产阶段**:
        *   基础镜像: `swr.cn-north-4.myhuaweicloud.com/shopping-ecommerce/nginx:alpine`。
        *   复制构建产物到 `/usr/share/nginx/html`。
        *   暴露端口 `80`。
        *   启动命令: `nginx -g "daemon off;"`。
*   Nginx核心配置通过Docker Compose卷挂载提供。

### 8.3 Nginx配置分析与生产环境代理问题

*   **Nginx主配置文件** ([`docker/nginx/nginx.conf`](docker/nginx/nginx.conf:1)): 定义全局设置，并通过 `include /etc/nginx/conf.d/*.conf;` 加载具体站点配置。
*   **默认站点配置文件** ([`docker/nginx/conf.d/default.conf`](docker/nginx/conf.d/default.conf:1)):
    *   监听 `80` 端口。
    *   根路径 `/` 提供前端静态文件，配置了SPA的回退 (`try_files $uri $uri/ /index.html;`)。
    *   **已配置的代理**:
        *   `/api/merchant/` -> `http://merchant-service:8081/merchant/api/merchant/`
        *   `/api/verification/` -> `http://merchant-service:8081/merchant/api/verification/`
        *   `/api/upload/` -> `http://file-service:8082/api/upload/`
        *   `/uploads/` -> `http://file-service:8082/uploads/`
    *   **严重问题：缺失核心API代理规则**
        *   没有为 `/api/user/*` (用户认证、商品、购物车) 配置代理到 `shop-service:8083`。
        *   没有为 `/api/cart/*` 配置代理到 `shop-service:8083`。
        *   没有为 `/api/user/orders/*`, `/api/user/shipping/*`, `/api/order/*` 配置代理到预期的 `order-service:8084` (其上下文路径为 `/order`)。
        *   这将导致这些API在生产环境中无法访问。

### 8.4 部署与运维建议

1.  **添加 `order-service` 到 `docker-compose.yml`**:
    *   需要为 `order-service` (源代码位于 `back_end/parent-project/order/`) 创建一个服务定义，包括构建上下文、Dockerfile路径（如果不在上下文根目录）、端口映射 (`8084:8084`)、环境变量（数据库连接信息应指向Docker网络中的`mysql`服务，并使用正确的凭证和数据库名）、卷挂载（日志）、网络配置和依赖。
2.  **修正Nginx代理配置 (`docker/nginx/conf.d/default.conf`)**:
    *   必须添加 `location` 块来代理到 `shop-service` 和 `order-service`。参考Vite的代理配置：
        ```nginx
        # 代理到 shop-service (用户认证、商品、购物车)
        location /api/user/auth/ {
            proxy_pass http://shop-service:8083/api/user/auth/;
            # ... (其他proxy_set_header等配置)
        }
        location /api/user/products/ { # 注意路径细节，确保与UserProductController匹配
            proxy_pass http://shop-service:8083/api/user/products/;
            # ...
        }
        location /api/user/categories/ {
             proxy_pass http://shop-service:8083/api/user/categories/;
             # ...
        }
        # 更通用的 /api/user/ 规则，如果其他路径也由shop-service处理
        # location /api/user/ {
        #     proxy_pass http://shop-service:8083/api/user/;
        #     # ...
        # }
        location /api/cart/ {
            proxy_pass http://shop-service:8083/api/cart/;
            # ...
        }

        # 代理到 order-service (订单、收货地址)
        location /api/user/orders/ {
            proxy_pass http://order-service:8084/order/api/user/orders/; # 注意order-service的上下文路径 /order
            # ...
        }
        location /api/user/shipping/ {
            proxy_pass http://order-service:8084/order/api/user/shipping/;
            # ...
        }
        # location /api/order/ { # 如果有更通用的订单接口
        #     proxy_pass http://order-service:8084/order/api/order/;
        #     # ...
        # }
        ```
    *   **重要**: 上述Nginx配置中的 `/api/user/products/` 和 `/api/user/categories/` 是基于 `UserProductController` 中方法映射的推断。如果 `/api/user/` 下还有其他非 `/auth` 的路径也由 `shop-service` 处理，可能需要一个更通用的 `/api/user/` location块，或者为每个子路径单独配置。最安全的方式是为每个由 `shop-service` 处理的 `/api/user/` 下的具体一级路径（如 `/api/user/products`, `/api/user/categories`）创建单独的location块。
3.  **统一和校验后端服务配置**:
    *   确保所有后端服务 (`shop-service`, `merchant-service`, `order-service`, `file-service`) 在其 `application-docker.yml` (或通过环境变量传递给Docker容器的配置) 中使用正确的数据库主机名 (`mysql`)、数据库名 (`shopping_ecommerce`) 和凭证 (`shopping`/`shopping123`)。目前 `order-service` 的 `application.yml` 使用的是 `localhost` 和 `root` 凭证，这是错误的。
    *   确保Redis连接信息在所有服务中也正确配置为指向Docker网络中的 `redis` 服务。
4.  **Dockerfile一致性与最佳实践**:
    *   考虑统一各服务Dockerfile的基础镜像和结构，例如都使用非root用户、统一`ENTRYPOINT`处理`$JAVA_OPTS`的方式。
    *   明确 `file-service` 的 `build.context` 和 `build.dockerfile` 路径。
    *   为 `shop-service` 的Dockerfile添加 `HEALTHCHECK` 指令。
5.  **日志管理**: 当前日志通过卷挂载到主机，可以考虑集成统一的日志收集系统（如ELK Stack, Grafana Loki）。
6.  **监控**: 各服务已暴露Actuator健康检查端点，可以集成Spring Boot Admin或Prometheus/Grafana进行更全面的监控。
7.  **安全性**:
    *   检查所有敏感配置（如数据库密码）是否已从代码库中移除，并通过环境变量或Docker Secrets管理。
    *   确保网络策略，例如只暴露必要的端口。

---
## 9. 已知问题与待改进点

基于当前对源代码和配置文件的分析，识别出以下主要问题和可改进点：

1.  **Nginx生产环境代理配置不完整**:
    *   **问题**: 当前 [`docker/nginx/conf.d/default.conf`](docker/nginx/conf.d/default.conf:1) 文件严重缺失对用户端核心API（`/api/user/*`, `/api/cart/*`, `/api/user/orders/*`, `/api/user/shipping/*`）的代理规则。
    *   **影响**: 这些API在Docker生产环境中将无法访问，导致用户端功能瘫痪。
    *   **建议**: 必须参照Vite开发代理配置，为Nginx添加正确的 `location` 块，将请求代理到 `shop-service:8083` 和 `order-service:8084`（并考虑其上下文路径 `/order`）。
2.  **`order-service` 未在 `docker-compose.yml` 中定义**:
    *   **问题**: 订单服务 (`order-service`，监听8084端口，上下文路径`/order`) 虽然在Vite配置和其自身`application.yml`中明确存在，但并未在主 [`docker-compose.yml`](docker-compose.yml:1) 文件中定义。
    *   **影响**: 订单服务无法通过Docker Compose启动和管理，导致生产环境订单功能缺失。
    *   **建议**: 需要在 [`docker-compose.yml`](docker-compose.yml:1) 中为 `order-service` 添加完整的服务定义，包括构建信息、端口映射、环境变量（特别是修正后的数据库连接）、网络、依赖等。
3.  **后端服务数据库配置不一致**:
    *   **问题**: `order-service` 的 [`application.yml`](back_end/parent-project/order/src/main/resources/application.yml:1) 中数据库URL指向 `localhost:3306/ecommerce_db` 并使用 `root/root` 凭证。这与Docker环境中MySQL服务 (`mysql:3306/shopping_ecommerce`，用户`shopping/shopping123`) 的配置冲突。
    *   **影响**: `order-service` 在Docker环境中无法连接到数据库。
    *   **建议**: 为 `order-service` 创建或修改其 `application-docker.yml` (或通过环境变量覆盖)，使其使用正确的Docker网络数据库主机名 (`mysql`)、数据库名 (`shopping_ecommerce`) 和用户凭证。同样，需要确保 `shop-service` 的数据库和Redis连接信息在Docker环境中是正确的（目前其 `docker-compose.yml` 中未显式配置这些连接串，依赖其内部打包的配置或环境变量）。
4.  **`file-service` Dockerfile路径**:
    *   **问题**: [`docker-compose.yml`](docker-compose.yml:1) 中 `file-service` 的 `build.context` 指向 `./back_end/parent-project/file`，但实际分析的 `Dockerfile` 位于 [`docker/file-service/Dockerfile`](docker/file-service/Dockerfile:1)。
    *   **影响**: `docker-compose build` 可能找不到正确的 `Dockerfile` 或使用了错误的上下文。
    *   **建议**: 在 `docker-compose.yml` 中为 `file-service` 明确指定 `build.dockerfile: ../../docker/file-service/Dockerfile` (路径相对于context调整) 或者将 [`docker/file-service/Dockerfile`](docker/file-service/Dockerfile:1) 移动到 `./back_end/parent-project/file/`。
5.  **`shop-service` Dockerfile 健康检查**:
    *   **问题**: [`back_end/parent-project/shop/Dockerfile`](back_end/parent-project/shop/Dockerfile:1) 中安装了 `curl` 用于健康检查，但未定义 `HEALTHCHECK` 指令。
    *   **影响**: 健康检查完全依赖于 `docker-compose.yml` 的定义。虽然功能上可能没问题，但在Dockerfile中声明更规范。
    *   **建议**: 在 `shop-service` 的Dockerfile中添加与 `docker-compose.yml` 一致的 `HEALTHCHECK` 指令。
6.  **`merchant-service` 健康检查URL**:
    *   **问题**: [`docker-compose.yml`](docker-compose.yml:1) 和 [`back_end/parent-project/merchant/Dockerfile`](back_end/parent-project/merchant/Dockerfile:1) 中 `merchant-service` 的健康检查URL为 `http://localhost:8081/actuator/health`。但Nginx代理规则和Spring Boot通常的上下文路径习惯表明，其Actuator端点应为 `http://localhost:8081/merchant/actuator/health`。
    *   **影响**: 当前健康检查可能失败。
    *   **建议**: 确认 `merchant-service` 的上下文路径是否为 `/merchant`，并相应更新健康检查URL。
7.  **代码中的硬编码/简单映射**:
    *   **问题**: `UserProductServiceImpl` 中的 `fillExtendedFields` 方法对 `storeName` 使用了简单映射 (`"店铺" + product.getStoreId()`)。
    *   **影响**: 店铺名称显示不正确。
    *   **建议**: 修改为从数据库实际查询店铺信息。
8.  **支付功能模拟**:
    *   **问题**: `UserOrderController` 中的支付接口当前为模拟实现。
    *   **影响**: 无法进行真实支付。
    *   **建议**: 对接真实的支付网关。

---

## 10. 总结

Shopping-Ecommerce项目是一个功能相对完整的电商平台，采用了前后端分离和微服务架构。后端通过Spring Boot构建了用户购物服务、商家服务、订单服务和文件服务，前端使用Vue 3技术栈。项目支持Docker容器化部署。

通过对现有源代码的详细分析，本文档梳理了项目的主要模块功能、API接口、数据库结构以及部署方式。同时，也指出了当前配置文件（特别是Docker Compose和Nginx）与代码所揭示的架构之间存在的一些不一致和过时之处，这些是项目后续需要重点关注和修正的地方，以确保系统在生产环境的稳定和正确运行。

此文档可作为理解项目当前状态、进行后续开发、以及排查配置问题的重要参考。建议开发团队根据本文档指出的问题点，对相关配置进行审查和更新。